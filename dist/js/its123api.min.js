!function(e){function t(r){if(n[r])return n[r].exports;var o=n[r]={exports:{},id:r,loaded:!1};return e[r].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}var o=n(1),s=r(o);window.Its123=s["default"]},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=n(2),u=r(a),c=n(3),l=n(4),d={domain:"https://api.123test.com",version:"v2",logErrors:!0,environment:"production",elements:{instrumentFormSelector:"form.its123-instrument",loadingElementId:"its123api-loading",productElementId:"its123api-product",reportElementId:"its123api-report",loadingElement:null,productElement:null,reportElement:null},maxRetries:2,retryDelay:5e3,apiKey:"not-set"},p=function(){function e(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];if(o(this,e),this.api=s({},d,t),this.api.endpoint=this.api.domain+"/"+this.api.version,this.api.environment="https://api.123test.dev"===this.api.domain?"development":"production","not-set"===this.api.apiKey)throw new Error("Api key must be set when initalising Its123 object. Please check your api config.");if(this.api.elements.loadingElement=document.getElementById(this.api.elements.loadingElementId),this.api.elements.productElement=document.getElementById(this.api.elements.productElementId),this.api.elements.reportElement=document.getElementById(this.api.elements.reportElementId),!this.api.elements.loadingElement||!this.api.elements.productElement||!this.api.elements.reportElement)throw new Error("Element for loading, product or report not found. Please check your HTML and Api config.");this.eventListeners={}}return i(e,[{key:"loadProduct",value:function(e){var t=this,n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],r=n.renderReport,o=void 0===r||r,s=n.storage,i=void 0===s||s,a=n.user,u=void 0===a?"":a,c={},l=void 0;return this.api.elements.productElement.style.display="none",this.api.elements.loadingElement.style.display="block",l=i?this.loadFromStorage(e,u)["catch"](function(){return t.requestProduct(e,u).then(function(n){return t.storeInStorage(e,n,u),n})}):this.requestProduct(e,u),l=l.then(function(e){c=e;var n=c.slots.instruments;return t.triggerEvent("instruments-loaded",n),i&&(n=n.filter(function(e){var n=t.getInstrumentStatusFromStorage(e.access_code);switch(n){case"ended-items":case"ended-skipped":case"ended-time":return t.triggerEvent("instrument-already-completed",{accessCode:e.access_code,status:n}),!1;case"in-progress":return t.triggerEvent("instrument-continue",{accessCode:e.access_code,status:n}),!0;case"started":default:return!0}})),n.reduce(function(e,n){var r=n.access_code;return e.then(function(){return t.requestInstrument(r)}).then(function(e){return t.triggerEvent("instrument-started",{accessCode:r,status:e.status}),t.processApiInstrumentResponse(r,e,i)})},Promise.resolve())}),o&&(l=l.then(function(){return t.loadReport(c.reports[0].access_code)})),l.then(function(){return t.clearStorage(e)}).then(function(){return t.triggerEvent("product-completed",c)}).then(function(){return c})["catch"](function(n){return i&&t.clearStorage(e),t.handleException(n)})}},{key:"loadReport",value:function(e){var t=this,n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],r=n.metaData,o=n.metaHmac;return this.requestReport(e,{metaData:r,metaHmac:o}).then(function(e){return t.renderReport(e)}).then(function(){return t.triggerEvent("report-ready")})}},{key:"processApiInstrumentResponse",value:function(e,t,n){var r=this,o=t.status,s=t.resources,i=t.body,a=void 0;switch(o){case"started":case"in-progress":return this.updateInstrumentInStorage(e,o),a=this.loadResources(s).then(function(){return r.renderInstrument(i)}),n&&(a=a.then(function(){return r.loadInstrumentStateFromStorage(e)}).then(function(){return r.bindInstrumentStorageListeners(e)})),a.then(function(){return r.runResourceFunctions(s)}).then(function(){return r.waitForInstrumentToSubmit()}).then(function(t){var n=t.form;return(0,c.tryAtMost)(r.api.maxRetries,r.api.retryDelay,function(){return r.submitInstrumentData(e,n)})}).then(function(t){return r.processApiInstrumentResponse(e,t)});case"ended-items":case"ended-skipped":case"ended-time":return this.updateInstrumentInStorage(e,o),this.triggerEvent("instrument-completed",{accessCode:e,status:o}),Promise.resolve();default:throw new Error("Unexpected instrument status "+o)}}},{key:"requestProduct",value:function(e,t){var n=this,r={"Content-Type":"application/json","X-123test-ApiKey":this.api.apiKey,"X-123test-ProductId":e};return t&&36===t.length&&(r["X-123test-Respondent"]=t),(0,u["default"])(this.api.endpoint+"/product/request-product",{method:"GET",mode:"cors",headers:r}).then(function(e){return e.json()}).then(function(e){return{slots:e.slots,reports:e.reports,product_access_code:e.product_access_code}})["catch"](function(e){switch(e.status){case 401:n.triggerEvent("invalid-api-key",e.response,"error");break;case 403:n.triggerEvent("product-no-access",e.response,"error")}throw e})}},{key:"requestProductInfo",value:function(e){var t={"Content-Type":"application/json","X-123test-ApiKey":this.api.apiKey};return(0,u["default"])(this.api.endpoint+"/product/"+e+"/overview",{method:"GET",mode:"cors",headers:t}).then(function(e){return e.json()}).then(function(e){return{slots:e.slots,reports:e.reports,product_access_code:e.product_access_code}})}},{key:"requestInstrument",value:function(e){return(0,u["default"])(this.api.endpoint+"/instrument/next-items",{method:"GET",cache:"no-cache",headers:{"X-123test-ApiKey":this.api.apiKey,"X-123test-InstrumentRun":e}}).then(function(e){return e.text().then(function(t){return{body:t,status:e.headers.get("X-123test-InstrumentStatus"),resources:JSON.parse(e.headers.get("X-123test-Resources"))}})})}},{key:"waitForInstrumentToSubmit",value:function(){var e=document.querySelector(this.api.elements.instrumentFormSelector);return new Promise(function(t){e.addEventListener("submit",function(n){n.preventDefault();for(var r=n.target.getElementsByTagName("button"),o=0;o<r.length;o++)r[o].disabled=!0;t({form:e,event:n})})})}},{key:"submitInstrumentData",value:function(e,t){return(0,u["default"])(this.api.endpoint+"/instrument/next-items",{method:"POST",cache:"no-cache",body:new FormData(t),headers:{"X-123test-ApiKey":this.api.apiKey,"X-123test-InstrumentRun":e}}).then(function(e){return e.text().then(function(t){return{body:t,status:e.headers.get("X-123test-InstrumentStatus"),resources:JSON.parse(e.headers.get("X-123test-Resources"))}})})}},{key:"renderInstrument",value:function(e){this.api.elements.productElement.innerHTML=e,this.api.elements.loadingElement.style.display="none",this.api.elements.productElement.style.display="initial"}},{key:"bindInstrumentStorageListeners",value:function(e){for(var t=this.api.elements.productElement.getElementsByTagName("input"),n=function(n){var r=t[n];"radio"===r.type&&r.addEventListener("change",function(){(0,l.saveToStorage)(e+"-"+r.name,r.value)})},r=0;r<t.length;r++)n(r)}},{key:"loadInstrumentStateFromStorage",value:function(e){for(var t=this.api.elements.productElement.getElementsByTagName("input"),n=!1,r=0;r<t.length;r++){var o=t[r],s=(0,l.getFromStorage)(e+"-"+o.name);null!==s&&"radio"===o.type&&o.value===s&&(o.checked=!0,n=!0)}n&&this.triggerEvent("instrument-item-data-loaded",{access_code:e})}},{key:"renderReport",value:function(e){this.api.elements.productElement.style.display="none",this.api.elements.loadingElement.style.display="none",this.api.elements.reportElement.innerHTML=e,this.api.elements.reportElement.style.display="initial"}},{key:"loadResources",value:function(e){return Promise.all(Object.keys(e).map(function(t){return new Promise(function(n,r){var o=e[t],s=document.getElementsByTagName("head")[0];if(document.querySelectorAll('script[src="'+o.path+'"]').length>0)return void n();switch(o.type){case"js":var i=document.createElement("script");i.src=o.path,i.async=o.async||!1,i.onload=n,s.appendChild(i);break;case"css":var a=document.createElement("link");a.rel="stylesheet",a.type="text/css",a.media="all",a.href=o.path,s.appendChild(a),n();break;default:r("Unknown resource type "+o.type)}})}))}},{key:"runResourceFunctions",value:function(e){var t=this;Object.keys(e).forEach(function(n){var r=e[n];"js"===r.type&&"function"==typeof window.its123[r.func]&&window.its123[r.func](t.api)})}},{key:"requestReport",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],n=t.metaData,r=void 0===n?"":n,o=t.metaHmac,s=void 0===o?"":o,i=void 0;return i=r.length<=0||s.length<=0?this.api.endpoint+"/report/"+e:this.api.endpoint+"/report/"+e+"?meta="+r+"&meta_hmac="+s,(0,u["default"])(i,{headers:{"X-123test-ApiKey":this.api.apiKey},method:"GET",mode:"cors"}).then(function(e){return e.text()})}},{key:"storeInStorage",value:function(e,t,n){var r=s({},t,{user:n,started:Date.now()});(0,l.saveToStorage)("its123Api-"+e,JSON.stringify(r))}},{key:"loadFromStorage",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?"":arguments[1],n=arguments.length<=2||void 0===arguments[2]?3600:arguments[2];return new Promise(function(r,o){var s=(0,l.getFromStorage)("its123Api-"+e);s||o("No storage present");var i=JSON.parse(s);i&&i.started+1e3*n>Date.now()&&i.user===t&&(console.info("Loading instrument from local storage."),r(i)),o("No product in local store")})}},{key:"clearStorage",value:function(e){var t=(0,l.getFromStorage)("its123Api-"+e);if(t){var n=JSON.parse(t);n.slots.instruments.forEach(function(e){(0,l.removeFromStorage)("its123Api-"+e.access_code),(0,l.removeFromStorageByPrefix)(e.access_code)}),(0,l.removeFromStorage)("its123Api-"+e)}}},{key:"updateInstrumentInStorage",value:function(e,t){(0,l.saveToStorage)("its123Api-"+e,t)}},{key:"getInstrumentStatusFromStorage",value:function(e){return(0,l.getFromStorage)("its123Api-"+e)}},{key:"handleException",value:function(e){if(this.api.logErrors)switch(e.status){case 401:case 403:console.error("123test API Permission error: "+e.message+" ("+e.status+")");break;case 404:console.error("123test API Product error: "+e.message+" ("+e.status+")");break;case 408:console.error("123test API Server error: API is unavailable"),this.triggerEvent("api-unavailable",e,"error");break;case 500:console.error("123test API Server error: "+e.message+" ("+e.status+")");break;default:throw e}this.triggerEvent("error",e,"error")}},{key:"getPdfUrl",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?"standard":arguments[1],n="premium"===t?221:121,r=e.reports.find(function(e){return e.type===n});if(!r)throw new Error("No access code for pdf is present in product object.");return this.api.endpoint+"/report/"+r.access_code}},{key:"triggerEvent",value:function(e,t){var n=arguments.length<=2||void 0===arguments[2]?"info":arguments[2],r=this.eventListeners[e];if(r&&r.length>0&&r.forEach(function(e){return e(t)}),"development"===this.api.environment)switch(n){case"error":console.error("Event triggered: "+e);break;case"info":default:console.info("Event triggered: "+e)}}},{key:"on",value:function(e,t){var n=this,r=[];Array.isArray(e)?r=e:r.push(e),r.forEach(function(e){n.eventListeners[e]||(n.eventListeners[e]=[]),n.eventListeners[e].push(t)})}}]),e}();t["default"]=p},function(e,t,n){"use strict";function r(e){if(e.status>=200&&e.status<300)return e;var t=new Error(e.statusText);throw t.response=e,t.status=e.status,t}function o(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],n=arguments.length<=2||void 0===arguments[2]?8e3:arguments[2];return(0,s.timeoutPromise)(n,fetch(e,t).then(r))}Object.defineProperty(t,"__esModule",{value:!0}),t["default"]=o;var s=n(3)},function(e,t){"use strict";function n(e,t){return new Promise(function(n,r){var o=setTimeout(function(){var e=new Error("timeout");e.status=408,r(e)},e);t.then(function(e){clearTimeout(o),n(e)},function(e){clearTimeout(o),r(e)})})}function r(e,t,n){var o=arguments.length<=3||void 0===arguments[3]?4:arguments[3],s=arguments.length<=4||void 0===arguments[4]?0:arguments[4];return new Promise(function(i,a){return n().then(i)["catch"](function(u){s<e?setTimeout(function(){return i(r(e,t*o,n,o,s+1))},t):a(u)})})}Object.defineProperty(t,"__esModule",{value:!0}),t.timeoutPromise=n,t.tryAtMost=r},function(e,t){"use strict";function n(e,t){a&&i.setItem(e,t)}function r(e){return a?i.getItem(e):null}function o(e){a&&i.removeItem(e)}function s(e){if(a)for(var t=i.length-1;t>=0;t--)i.key(t).startsWith(e)&&i.removeItem(i.key(t))}Object.defineProperty(t,"__esModule",{value:!0}),t.saveToStorage=n,t.getFromStorage=r,t.removeFromStorage=o,t.removeFromStorageByPrefix=s;var i=window.localStorage,a=function(){var e="test";try{return i.setItem(e,e),i.removeItem(e),!0}catch(t){return!1}}()}]);
//# sourceMappingURL=its123api.min.js.map